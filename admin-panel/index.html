<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle Gacha - Admin Panel</title>
    <link rel="stylesheet" href="styles/admin.css">
    <style>
        /* Console de debug */
        .debug-console {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: #1e1e1e;
            border-top: 2px solid #333;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
        }
        
        .console-header {
            background: #333;
            padding: 8px 12px;
            color: #fff;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .console-content {
            flex: 1;
            padding: 8px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .console-input {
            display: flex;
            padding: 8px;
            background: #2d2d2d;
        }
        
        .console-input input {
            flex: 1;
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            outline: none;
        }
        
        .console-toggle {
            background: #007acc;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
        }
        
        .console-clear {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            margin-left: 8px;
        }
        
        .log-info { color: #00ff00; }
        .log-warn { color: #ffa500; }
        .log-error { color: #ff4444; }
        .log-debug { color: #888; }
        .log-success { color: #00ff88; }
        
        /* Ajuster le body pour la console */
        body.console-open {
            padding-bottom: 200px;
        }
    </style>
</head>
<body class="console-open">
    <div class="admin-container">
        <!-- Login Form -->
        <div id="loginSection" class="login-form">
            <h1>üéÆ Admin Panel</h1>
            <div id="loginAlert"></div>
            
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" value="superadmin" required>
            </div>
            
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" value="ChangeMe123!" required>
            </div>
            
            <button id="loginBtn" class="btn" onclick="handleLogin()">
                Login to Admin Panel
            </button>
        </div>

        <!-- Dashboard -->
        <div id="dashboardSection" class="dashboard">
            <!-- Header -->
            <div class="header">
                <h1>üéÆ Idle Gacha Admin</h1>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">SA</div>
                    <div>
                        <div id="userName">Super Admin</div>
                        <div class="user-role" id="userRole">super_admin</div>
                    </div>
                    <button class="btn logout-btn" onclick="handleLogout()">Logout</button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card" onclick="showSection('overview')">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value" id="totalPlayers">-</div>
                    <div class="stat-label">Active Players</div>
                </div>
                <div class="stat-card" onclick="showSection('overview')">
                    <div class="stat-icon">üíé</div>
                    <div class="stat-value" id="todayRevenue">-</div>
                    <div class="stat-label">Today's Revenue</div>
                </div>
                <div class="stat-card" onclick="showSection('overview')">
                    <div class="stat-icon">üë®‚Äçüíº</div>
                    <div class="stat-value" id="onlineAdmins">-</div>
                    <div class="stat-label">Online Admins</div>
                </div>
                <div class="stat-card health-card" onclick="showSection('overview')">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-value" id="systemHealth">-</div>
                    <div class="stat-label">System Health</div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showSection('overview')">üìä Overview</div>
                <div class="nav-tab" onclick="showSection('players')">üë• Players</div>
                <div class="nav-tab" onclick="showSection('economy')">üí∞ Economy</div>
                <div class="nav-tab" onclick="showSection('logs')">üìú Audit Logs</div>
                <div class="nav-tab" onclick="showSection('system')">‚öôÔ∏è System</div>
            </div>

            <!-- Content Sections -->
            <div class="content-container">
                <!-- Overview Section -->
                <div id="overviewSection" class="content-section active">
                    <h2 class="section-title">üìä System Overview</h2>
                    <div id="overviewContent">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading dashboard data...</p>
                        </div>
                    </div>
                </div>

                <!-- Players Section -->
                <div id="playersSection" class="content-section">
                    <h2 class="section-title">üë• Player Management</h2>
                    <div id="playersContent">
                        <!-- Content will be loaded by players.js module -->
                    </div>
                </div>

                <!-- Economy Section -->
                <div id="economySection" class="content-section">
                    <h2 class="section-title">üí∞ Economy Analytics</h2>
                    <div id="economyContent">
                        <div class="placeholder">
                            <h3>üöß Coming Soon</h3>
                            <p>Economy analytics module will be implemented here...</p>
                        </div>
                    </div>
                </div>

                <!-- Logs Section -->
                <div id="logsSection" class="content-section">
                    <h2 class="section-title">üìú Audit Logs</h2>
                    <div id="logsContent">
                        <div class="placeholder">
                            <h3>üöß Coming Soon</h3>
                            <p>Audit logs module will be implemented here...</p>
                        </div>
                    </div>
                </div>

                <!-- System Section -->
                <div id="systemSection" class="content-section">
                    <h2 class="section-title">‚öôÔ∏è System Information</h2>
                    <div id="systemContent">
                        <div class="placeholder">
                            <h3>üöß Coming Soon</h3>
                            <p>System information module will be implemented here...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Alert System -->
    <div id="globalAlert" class="global-alert"></div>

    <!-- Console de Debug -->
    <div class="debug-console" id="debugConsole">
        <div class="console-header">
            <span>üêõ Debug Console</span>
            <div>
                <button class="console-clear" onclick="clearConsole()">Clear</button>
                <button class="console-toggle" onclick="toggleConsole()">Hide</button>
            </div>
        </div>
        <div class="console-content" id="consoleContent"></div>
        <div class="console-input">
            <span>></span>
            <input type="text" id="consoleInput" placeholder="Type JavaScript command..." onkeypress="handleConsoleInput(event)">
        </div>
    </div>

    <script>
        // ===== CONSOLE DE DEBUG =====
        let consoleVisible = true;
        let logCount = 0;

        function log(message, type = 'info') {
            logCount++;
            const timestamp = new Date().toLocaleTimeString();
            const consoleContent = document.getElementById('consoleContent');
            const logLine = document.createElement('div');
            logLine.className = `log-${type}`;
            logLine.textContent = `[${timestamp}] [${logCount}] ${message}`;
            consoleContent.appendChild(logLine);
            consoleContent.scrollTop = consoleContent.scrollHeight;
            
            // Aussi dans la vraie console
            console.log(`[ADMIN PANEL] ${message}`);
        }

        function clearConsole() {
            document.getElementById('consoleContent').innerHTML = '';
            logCount = 0;
        }

        function toggleConsole() {
            const console = document.getElementById('debugConsole');
            const body = document.body;
            consoleVisible = !consoleVisible;
            
            if (consoleVisible) {
                console.style.display = 'flex';
                body.classList.add('console-open');
                document.querySelector('.console-toggle').textContent = 'Hide';
            } else {
                console.style.display = 'none';
                body.classList.remove('console-open');
                document.querySelector('.console-toggle').textContent = 'Show';
            }
        }

        function handleConsoleInput(event) {
            if (event.key === 'Enter') {
                const input = event.target;
                const command = input.value;
                log(`> ${command}`, 'debug');
                
                try {
                    const result = eval(command);
                    log(`< ${JSON.stringify(result)}`, 'success');
                } catch (error) {
                    log(`< Error: ${error.message}`, 'error');
                }
                
                input.value = '';
            }
        }

        // ===== OVERRIDE CONSOLE METHODS =====
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            log(args.join(' '), 'info');
            originalLog.apply(console, args);
        };

        console.error = function(...args) {
            log(args.join(' '), 'error');
            originalError.apply(console, args);
        };

        console.warn = function(...args) {
            log(args.join(' '), 'warn');
            originalWarn.apply(console, args);
        };

        // ===== ADMIN CORE FUNCTIONALITY =====
        let adminToken = localStorage.getItem('adminToken');
        let adminUser = null;

        // Log initial
        log('üîß Initializing Admin Panel with Debug Console...', 'info');
        log(`üìç Current URL: ${window.location.href}`, 'debug');
        log(`üîë Stored token: ${adminToken ? 'YES' : 'NO'}`, 'debug');

        // Fonction de login avec debug
        async function handleLogin() {
            log('üîê Login button clicked!', 'info');
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');

            log(`üìù Username: ${username}`, 'debug');
            log(`üîí Password: ${password ? '[PROVIDED]' : '[EMPTY]'}`, 'debug');

            if (!username || !password) {
                log('‚ùå Username and password are required', 'error');
                showAlert('Please enter both username and password', 'error');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';
            log('üîÑ Starting login request...', 'info');

            try {
                const requestBody = { username, password };
                log(`üì§ Request body: ${JSON.stringify(requestBody)}`, 'debug');
                
                const response = await fetch('/api/admin/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                log(`üì• Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log(`üìç Response URL: ${response.url}`, 'debug');
                
                const responseHeaders = {};
                response.headers.forEach((value, key) => {
                    responseHeaders[key] = value;
                });
                log(`üìã Response headers: ${JSON.stringify(responseHeaders)}`, 'debug');

                const data = await response.json();
                log(`üì¶ Response data: ${JSON.stringify(data, null, 2)}`, 'debug');

                if (response.ok && data.success) {
                    log('‚úÖ Login successful!', 'success');
                    
                    adminToken = data.data.token;
                    adminUser = data.data.admin;
                    localStorage.setItem('adminToken', adminToken);
                    
                    log(`üé´ Token stored: ${adminToken.substring(0, 20)}...`, 'debug');
                    log(`üë§ Admin user: ${JSON.stringify(adminUser)}`, 'debug');
                    
                    showAlert('Login successful! Loading dashboard...', 'success');
                    
                    setTimeout(() => {
                        showDashboard();
                        loadDashboardData();
                    }, 1000);
                } else {
                    log(`‚ùå Login failed: ${data.message || 'Unknown error'}`, 'error');
                    showAlert(data.error || data.message || 'Login failed', 'error');
                }
            } catch (error) {
                log(`üí• Network error: ${error.message}`, 'error');
                log(`üîç Error details: ${JSON.stringify(error)}`, 'debug');
                showAlert(`Connection error: ${error.message}`, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login to Admin Panel';
                log('üîÑ Login process completed', 'debug');
            }
        }

        function handleLogout() {
            log('üö™ Logout clicked', 'info');
            localStorage.removeItem('adminToken');
            adminToken = null;
            adminUser = null;
            
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'none';
            
            showAlert('Logged out successfully', 'info');
            log('‚úÖ Logout completed', 'success');
        }

        function showDashboard() {
            log('üè† Showing dashboard', 'info');
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            
            if (adminUser) {
                document.getElementById('userName').textContent = adminUser.username;
                document.getElementById('userRole').textContent = adminUser.role;
                document.getElementById('userAvatar').textContent = adminUser.username.substring(0, 2).toUpperCase();
                log(`üë§ Dashboard loaded for: ${adminUser.username}`, 'success');
            }
        }

        function loadDashboardData() {
            log('üìä Loading dashboard data...', 'info');
            // Placeholder pour les donn√©es
            document.getElementById('totalPlayers').textContent = '1,234';
            document.getElementById('todayRevenue').textContent = '$567.89';
            document.getElementById('onlineAdmins').textContent = '3';
            document.getElementById('systemHealth').textContent = 'Good';
            log('‚úÖ Dashboard data loaded (mock data)', 'success');
        }

        function showSection(section) {
            log(`üîÄ Switching to section: ${section}`, 'info');
            
            // Masquer toutes les sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Retirer active de tous les onglets
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Afficher la section s√©lectionn√©e
            const sectionElement = document.getElementById(section + 'Section');
            const tabElement = event?.target?.classList.contains('nav-tab') ? event.target : 
                document.querySelector(`.nav-tab[onclick*="${section}"]`);
            
            if (sectionElement) sectionElement.classList.add('active');
            if (tabElement) tabElement.classList.add('active');
            
            log(`‚úÖ Section ${section} activated`, 'success');
        }

        function showAlert(message, type = 'info', duration = 5000) {
            log(`üö® Alert: ${message} (${type})`, type === 'error' ? 'error' : 'info');
            
            const alertContainer = document.getElementById('globalAlert');
            
            alertContainer.innerHTML = `
                <div class="alert ${type} slide-in">
                    <span class="alert-icon">
                        ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                    </span>
                    <span class="alert-message">${message}</span>
                    <button class="alert-close" onclick="this.parentElement.remove()">√ó</button>
                </div>
            `;
            
            alertContainer.style.display = 'block';
            
            if (duration > 0) {
                setTimeout(() => {
                    const alert = alertContainer.querySelector('.alert');
                    if (alert) {
                        alert.classList.add('slide-out');
                        setTimeout(() => alertContainer.style.display = 'none', 300);
                    }
                }, duration);
            }
        }

        // Test de connectivit√© au d√©marrage
        window.addEventListener('load', async () => {
            log('üåê Page loaded, testing connectivity...', 'info');
            
            try {
                const response = await fetch('/api/admin/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                log(`üîç Auth test: ${response.status}`, response.ok ? 'success' : 'warn');
                
                if (adminToken && response.ok) {
                    log('üéØ Auto-login attempt...', 'info');
                    const data = await response.json();
                    adminUser = data.data.admin;
                    showDashboard();
                    loadDashboardData();
                }
            } catch (error) {
                log(`‚ö†Ô∏è Auth test failed: ${error.message}`, 'warn');
            }
        });

        // Test de l'API au d√©marrage
        fetch('/api/admin/dashboard/quick-stats')
            .then(response => {
                log(`üéØ API test: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                return response.json();
            })
            .then(data => {
                log(`üìä API data: ${JSON.stringify(data)}`, 'debug');
            })
            .catch(error => {
                log(`‚ùå API test failed: ${error.message}`, 'error');
            });

        log('‚úÖ Admin Panel initialized with full debug support!', 'success');
    </script>
</body>
</html>

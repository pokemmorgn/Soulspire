// server/src/gameplay/effects/debuffs/vulnerability.ts
import { IBattleParticipant } from "../../../models/Battle";
import { BaseEffect, IEffectConfig, EffectResult } from "../base/BaseEffect";

/**
 * Effet Vulnerability (VulnÃ©rabilitÃ©)
 * - Augmente les dÃ©gÃ¢ts reÃ§us de 25% (non stackable)
 * - DurÃ©e courte (2 tours)
 * - Affecte TOUS les types de dÃ©gÃ¢ts reÃ§us
 * - TrÃ¨s puissant pour setup un burst
 */
export class VulnerabilityEffect extends BaseEffect {
  constructor() {
    const config: IEffectConfig = {
      id: "vulnerability",
      name: "VulnÃ©rabilitÃ©",
      description: "La cible prend plus de dÃ©gÃ¢ts",
      type: "debuff",
      category: "stat_modifier",
      stackable: false, // Trop puissant pour stack
      maxStacks: 1,
      baseDuration: 2
    };
    
    super(config);
  }
  
  onApply(target: IBattleParticipant, appliedBy: IBattleParticipant): EffectResult {
    return {
      message: `ğŸ¯ ${target.name} devient vulnÃ©rable !`
    };
  }
  
  onTick(target: IBattleParticipant, stacks: number, appliedBy: IBattleParticipant): EffectResult {
    // Vulnerability n'a pas d'effet par tour (pas de dÃ©gÃ¢ts)
    // L'effet est appliquÃ© lors du calcul des dÃ©gÃ¢ts dans BattleEngine
    
    return {
      message: `ğŸ¯ ${target.name} est vulnÃ©rable (+25% dÃ©gÃ¢ts reÃ§us)`,
      statModifiers: {
        damageReceived: 25
      }
    };
  }
  
  onRemove(target: IBattleParticipant): EffectResult {
    return {
      message: `ğŸ›¡ï¸ ${target.name} n'est plus vulnÃ©rable`
    };
  }
  
  // VÃ©rifier si la cible peut devenir vulnÃ©rable
  canApplyTo(target: IBattleParticipant, appliedBy: IBattleParticipant): boolean {
    // ImmunitÃ© gÃ©nÃ©rale
    if (target.status.buffs.includes("immunity")) {
      console.log(`ğŸ›¡ï¸ ${target.name} est immunisÃ© aux debuffs`);
      return false;
    }
    
    // ImmunitÃ© spÃ©cifique (fortify, protection = rÃ©siste Ã  la vulnÃ©rabilitÃ©)
    if (target.status.buffs.includes("fortify") || target.status.buffs.includes("protection")) {
      console.log(`ğŸ›¡ï¸ ${target.name} rÃ©siste Ã  la vulnÃ©rabilitÃ© (Fortify active)`);
      return false;
    }
    
    // Les Tanks ont 20% de rÃ©sistance (protecteurs naturels)
    if (target.role === "Tank") {
      const resistanceChance = 0.2; // 20%
      if (Math.random() < resistanceChance) {
        console.log(`ğŸ›¡ï¸ ${target.name} rÃ©siste Ã  la vulnÃ©rabilitÃ© (Tank resistance)`);
        return false;
      }
    }
    
    return true;
  }
  
  /**
   * VÃ©rifier si une cible est vulnÃ©rable
   * @param target - Cible Ã  vÃ©rifier
   * @returns true si vulnÃ©rable
   */
  static isVulnerable(target: IBattleParticipant): boolean {
    const activeEffects = (target as any).activeEffects as any[];
    if (!activeEffects) return false;
    
    return activeEffects.some((effect: any) => effect.id === "vulnerability");
  }
  
  /**
   * Obtenir le multiplicateur de dÃ©gÃ¢ts pour une cible vulnÃ©rable
   * @param target - Cible Ã  vÃ©rifier
   * @returns Multiplicateur (1.0 si pas vulnÃ©rable, 1.25 si vulnÃ©rable)
   */
  static getDamageMultiplier(target: IBattleParticipant): number {
    return this.isVulnerable(target) ? 1.25 : 1.0;
  }
  
  /**
   * Appliquer le multiplicateur de vulnÃ©rabilitÃ© aux dÃ©gÃ¢ts
   * @param target - Cible qui reÃ§oit les dÃ©gÃ¢ts
   * @param baseDamage - DÃ©gÃ¢ts de base
   * @returns DÃ©gÃ¢ts aprÃ¨s multiplicateur
   */
  static applyVulnerability(target: IBattleParticipant, baseDamage: number): number {
    if (!this.isVulnerable(target)) return baseDamage;
    
    const increasedDamage = Math.floor(baseDamage * 1.25);
    console.log(`ğŸ¯ VulnÃ©rabilitÃ© augmente les dÃ©gÃ¢ts de ${target.name} (+25%)`);
    
    return increasedDamage;
  }
}

// Export de l'instance pour EffectManager
export const vulnerabilityEffect = new VulnerabilityEffect();
